name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * *' # 3 AM UTC daily — keeps refresh tokens alive
  workflow_dispatch:

# Cancel stale PR runs; never cancel push/schedule runs.
concurrency:
  group: ci-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  id-token: write # OIDC federation with Azure (integration + e2e jobs)

jobs:
  # --- Always-run jobs (including fork PRs) ---

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.8.0

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Test (with race detector)
        run: go test -race ./...

  # --- Live API jobs (skip on forks — no OIDC trust) ---
  # Each job uses its own dedicated test account so they run in parallel
  # without OAuth token refresh races.

  integration:
    runs-on: ubuntu-latest
    if: vars.AZURE_CLIENT_ID != ''
    env:
      ONEDRIVE_TEST_DRIVE: ${{ vars.ONEDRIVE_TEST_DRIVE_INTEGRATION }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Azure OIDC login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Load token from Key Vault
        run: |
          set -euo pipefail
          DATA_DIR="$HOME/.local/share/onedrive-go"
          mkdir -p "$DATA_DIR"

          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_FILE="token_${SANITIZED}.json"
          TOKEN_PATH="${DATA_DIR}/${TOKEN_FILE}"
          SECRET_NAME="onedrive-oauth-token-$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@.]/-/g')"

          echo "Loading token for: ${ONEDRIVE_TEST_DRIVE} (secret: ${SECRET_NAME})"
          az keyvault secret download \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file "$TOKEN_PATH" \
            --encoding utf-8

          if ! jq -e '.token.refresh_token' "$TOKEN_PATH" > /dev/null 2>&1; then
            echo "::error::Token is missing .token.refresh_token"
            exit 1
          fi

          echo "Token loaded: ${TOKEN_PATH}"

      - name: Bootstrap token metadata
        run: |
          set -euo pipefail
          DATA_DIR="$HOME/.local/share/onedrive-go"

          WHOAMI_JSON=$(go run . whoami --json --drive "$ONEDRIVE_TEST_DRIVE")
          DRIVE_ID=$(echo "$WHOAMI_JSON" | jq -r '.drives[0].id')
          USER_ID=$(echo "$WHOAMI_JSON" | jq -r '.user.id')
          DISPLAY_NAME=$(echo "$WHOAMI_JSON" | jq -r '.user.display_name')

          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_PATH="${DATA_DIR}/token_${SANITIZED}.json"

          jq --arg did "$DRIVE_ID" --arg uid "$USER_ID" --arg dn "$DISPLAY_NAME" \
            '.meta = (.meta // {}) + {
              "drive_id": $did,
              "user_id": $uid,
              "display_name": $dn,
              "org_name": "",
              "cached_at": (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
            }' "$TOKEN_PATH" > "${TOKEN_PATH}.tmp" \
            && mv "${TOKEN_PATH}.tmp" "$TOKEN_PATH" \
            && chmod 600 "$TOKEN_PATH"

          echo "drive_id=${DRIVE_ID} user_id=${USER_ID}"

          # Export DRIVE_ID for the test step.
          echo "ONEDRIVE_TEST_DRIVE_ID=${DRIVE_ID}" >> "$GITHUB_ENV"

      - name: Run integration tests
        run: |
          set -euo pipefail
          echo "=== Integration tests for: ${ONEDRIVE_TEST_DRIVE} ==="
          ONEDRIVE_ALLOWED_TEST_ACCOUNTS="$ONEDRIVE_TEST_DRIVE" \
            go test -tags=integration -race -v -timeout=5m ./internal/graph/...

      - name: Save rotated token to Key Vault
        if: always()
        run: |
          set -euo pipefail
          DATA_DIR="$HOME/.local/share/onedrive-go"
          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_PATH="${DATA_DIR}/token_${SANITIZED}.json"
          SECRET_NAME="onedrive-oauth-token-$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@.]/-/g')"

          if [ ! -f "$TOKEN_PATH" ]; then
            echo "::warning::Token file missing — skipping save"
            exit 0
          fi

          if ! jq -e '.token.refresh_token' "$TOKEN_PATH" > /dev/null 2>&1; then
            echo "::warning::Token has no .token.refresh_token — skipping save"
            exit 0
          fi

          echo "Saving rotated token"
          az keyvault secret set \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file "$TOKEN_PATH" \
            --content-type "application/json" \
            --output none

  e2e:
    runs-on: ubuntu-latest
    if: vars.AZURE_CLIENT_ID != ''
    env:
      ONEDRIVE_TEST_DRIVE: ${{ vars.ONEDRIVE_TEST_DRIVE_E2E }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Azure OIDC login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Load token from Key Vault
        run: |
          set -euo pipefail
          DATA_DIR="$HOME/.local/share/onedrive-go"
          mkdir -p "$DATA_DIR"

          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_FILE="token_${SANITIZED}.json"
          TOKEN_PATH="${DATA_DIR}/${TOKEN_FILE}"
          SECRET_NAME="onedrive-oauth-token-$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@.]/-/g')"

          echo "Loading token for: ${ONEDRIVE_TEST_DRIVE} (secret: ${SECRET_NAME})"
          az keyvault secret download \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file "$TOKEN_PATH" \
            --encoding utf-8

          if ! jq -e '.token.refresh_token' "$TOKEN_PATH" > /dev/null 2>&1; then
            echo "::error::Token is missing .token.refresh_token"
            exit 1
          fi

          echo "Token loaded: ${TOKEN_PATH}"

      - name: Bootstrap token metadata
        run: |
          set -euo pipefail
          DATA_DIR="$HOME/.local/share/onedrive-go"

          WHOAMI_JSON=$(go run . whoami --json --drive "$ONEDRIVE_TEST_DRIVE")
          DRIVE_ID=$(echo "$WHOAMI_JSON" | jq -r '.drives[0].id')
          USER_ID=$(echo "$WHOAMI_JSON" | jq -r '.user.id')
          DISPLAY_NAME=$(echo "$WHOAMI_JSON" | jq -r '.user.display_name')

          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_PATH="${DATA_DIR}/token_${SANITIZED}.json"

          jq --arg did "$DRIVE_ID" --arg uid "$USER_ID" --arg dn "$DISPLAY_NAME" \
            '.meta = (.meta // {}) + {
              "drive_id": $did,
              "user_id": $uid,
              "display_name": $dn,
              "org_name": "",
              "cached_at": (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
            }' "$TOKEN_PATH" > "${TOKEN_PATH}.tmp" \
            && mv "${TOKEN_PATH}.tmp" "$TOKEN_PATH" \
            && chmod 600 "$TOKEN_PATH"

          echo "drive_id=${DRIVE_ID} user_id=${USER_ID}"

      - name: Create config file
        run: |
          set -euo pipefail
          CONFIG_DIR="$HOME/.config/onedrive-go"
          mkdir -p "$CONFIG_DIR"
          CONFIG_PATH="${CONFIG_DIR}/config.toml"

          echo "# CI-generated config" > "$CONFIG_PATH"
          echo "" >> "$CONFIG_PATH"
          echo "[\"${ONEDRIVE_TEST_DRIVE}\"]" >> "$CONFIG_PATH"

          echo "Config written: ${CONFIG_PATH}"
          cat "$CONFIG_PATH"

      - name: Run E2E tests
        run: |
          set -euo pipefail

          # Full suite on schedule/dispatch, fast-only on push/PR.
          E2E_TAGS="e2e"
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            E2E_TAGS="e2e,e2e_full"
          fi

          echo "=== E2E tests (tags: ${E2E_TAGS}) ==="
          E2E_LOG_DIR=/tmp/e2e-debug-logs \
          ONEDRIVE_ALLOWED_TEST_ACCOUNTS="$ONEDRIVE_TEST_DRIVE" \
            go test -tags="${E2E_TAGS}" -race -v -timeout=30m ./e2e/...

      - name: Upload E2E debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-debug-logs
          path: /tmp/e2e-debug-logs/
          retention-days: 7

      - name: Save rotated token to Key Vault
        if: always()
        run: |
          set -euo pipefail
          DATA_DIR="$HOME/.local/share/onedrive-go"
          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_PATH="${DATA_DIR}/token_${SANITIZED}.json"
          SECRET_NAME="onedrive-oauth-token-$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@.]/-/g')"

          if [ ! -f "$TOKEN_PATH" ]; then
            echo "::warning::Token file missing — skipping save"
            exit 0
          fi

          if ! jq -e '.token.refresh_token' "$TOKEN_PATH" > /dev/null 2>&1; then
            echo "::warning::Token has no .token.refresh_token — skipping save"
            exit 0
          fi

          echo "Saving rotated token"
          az keyvault secret set \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file "$TOKEN_PATH" \
            --content-type "application/json" \
            --output none

      - name: Auth failure guidance
        if: failure()
        run: |
          echo "::warning::E2E test auth may have failed."
          echo "::warning::If the refresh token has expired (90 days idle), re-bootstrap."
          echo "::warning::See docs/design/test-strategy.md for re-bootstrap instructions."
