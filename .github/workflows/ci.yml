name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * *' # 3 AM UTC daily — keeps refresh tokens alive
  workflow_dispatch:

# Cancel stale PR runs; never cancel push/schedule runs.
concurrency:
  group: ci-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  id-token: write # OIDC federation with Azure (integration + e2e jobs)

jobs:
  # --- Always-run jobs (including fork PRs) ---

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.8.0

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Test (with race detector)
        run: go test -race ./...

  # --- Live API jobs (skip on forks — no OIDC trust) ---

  integration:
    runs-on: ubuntu-latest
    if: vars.AZURE_CLIENT_ID != ''
    env:
      ONEDRIVE_TEST_DRIVES: ${{ vars.ONEDRIVE_TEST_DRIVES || 'personal:test@example.com' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Azure OIDC login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Load tokens from Key Vault
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          DATA_DIR="$HOME/.local/share/onedrive-go"
          mkdir -p "$DATA_DIR"

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            sanitized=$(echo "$drive" | sed 's/:/_/')
            token_file="token_${sanitized}.json"
            token_path="${DATA_DIR}/${token_file}"
            secret_name="onedrive-oauth-token-$(echo "$drive" | sed 's/[:@.]/-/g')"

            echo "Loading token for drive: ${drive} (secret: ${secret_name})"
            az keyvault secret download \
              --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
              --name "$secret_name" \
              --file "$token_path" \
              --encoding utf-8

            if ! jq -e '.token.refresh_token' "$token_path" > /dev/null 2>&1; then
              echo "::error::Token for drive '${drive}' is missing .token.refresh_token"
              exit 1
            fi

            echo "Token loaded: ${drive} -> ${token_path}"
          done

      - name: Bootstrap token metadata
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          DATA_DIR="$HOME/.local/share/onedrive-go"

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            echo "=== Bootstrapping metadata for: ${drive} ==="

            WHOAMI_JSON=$(go run . whoami --json --drive "$drive")
            DRIVE_ID=$(echo "$WHOAMI_JSON" | jq -r '.drives[0].id')
            USER_ID=$(echo "$WHOAMI_JSON" | jq -r '.user.id')
            DISPLAY_NAME=$(echo "$WHOAMI_JSON" | jq -r '.user.display_name')

            sanitized=$(echo "$drive" | sed 's/:/_/')
            token_path="${DATA_DIR}/token_${sanitized}.json"

            jq --arg did "$DRIVE_ID" --arg uid "$USER_ID" --arg dn "$DISPLAY_NAME" \
              '.meta = (.meta // {}) + {
                "drive_id": $did,
                "user_id": $uid,
                "display_name": $dn,
                "org_name": "",
                "cached_at": (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }' "$token_path" > "${token_path}.tmp" \
              && mv "${token_path}.tmp" "$token_path" \
              && chmod 600 "$token_path"

            echo "  drive_id=${DRIVE_ID} user_id=${USER_ID}"
          done

      - name: Run integration tests
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          DATA_DIR="$HOME/.local/share/onedrive-go"

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)

            sanitized=$(echo "$drive" | sed 's/:/_/')
            token_path="${DATA_DIR}/token_${sanitized}.json"
            DRIVE_ID=$(jq -r '.meta.drive_id' "$token_path")

            echo "=== Integration tests for: ${drive} (drive_id: ${DRIVE_ID}) ==="
            ONEDRIVE_TEST_DRIVE="$drive" \
              ONEDRIVE_TEST_DRIVE_ID="$DRIVE_ID" \
              ONEDRIVE_ALLOWED_TEST_ACCOUNTS="$ONEDRIVE_TEST_DRIVES" \
              go test -tags=integration -race -v -timeout=5m ./internal/graph/...
          done

      - name: Save rotated tokens to Key Vault
        if: always()
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          DATA_DIR="$HOME/.local/share/onedrive-go"

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            sanitized=$(echo "$drive" | sed 's/:/_/')
            token_path="${DATA_DIR}/token_${sanitized}.json"
            secret_name="onedrive-oauth-token-$(echo "$drive" | sed 's/[:@.]/-/g')"

            if [ ! -f "$token_path" ]; then
              echo "::warning::Token file missing for drive '${drive}' — skipping save"
              continue
            fi

            if ! jq -e '.token.refresh_token' "$token_path" > /dev/null 2>&1; then
              echo "::warning::Token for drive '${drive}' has no .token.refresh_token — skipping save"
              continue
            fi

            echo "Saving rotated token for drive: ${drive}"
            az keyvault secret set \
              --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
              --name "$secret_name" \
              --file "$token_path" \
              --content-type "application/json" \
              --output none
          done

  e2e:
    runs-on: ubuntu-latest
    if: vars.AZURE_CLIENT_ID != ''
    env:
      ONEDRIVE_TEST_DRIVES: ${{ vars.ONEDRIVE_TEST_DRIVES || 'personal:test@example.com' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Azure OIDC login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Load tokens from Key Vault
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          DATA_DIR="$HOME/.local/share/onedrive-go"
          mkdir -p "$DATA_DIR"

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            sanitized=$(echo "$drive" | sed 's/:/_/')
            token_file="token_${sanitized}.json"
            token_path="${DATA_DIR}/${token_file}"
            secret_name="onedrive-oauth-token-$(echo "$drive" | sed 's/[:@.]/-/g')"

            echo "Loading token for drive: ${drive} (secret: ${secret_name})"
            az keyvault secret download \
              --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
              --name "$secret_name" \
              --file "$token_path" \
              --encoding utf-8

            if ! jq -e '.token.refresh_token' "$token_path" > /dev/null 2>&1; then
              echo "::error::Token for drive '${drive}' is missing .token.refresh_token"
              exit 1
            fi

            echo "Token loaded: ${drive} -> ${token_path}"
          done

      - name: Create config file for test drives
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          CONFIG_DIR="$HOME/.config/onedrive-go"
          mkdir -p "$CONFIG_DIR"
          CONFIG_PATH="${CONFIG_DIR}/config.toml"

          echo "# CI-generated config" > "$CONFIG_PATH"
          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            echo "" >> "$CONFIG_PATH"
            echo "[\"${drive}\"]" >> "$CONFIG_PATH"
          done

          echo "Config written: ${CONFIG_PATH}"
          cat "$CONFIG_PATH"

      - name: Bootstrap token metadata
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          DATA_DIR="$HOME/.local/share/onedrive-go"

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            echo "=== Bootstrapping metadata for: ${drive} ==="

            WHOAMI_JSON=$(go run . whoami --json --drive "$drive")
            DRIVE_ID=$(echo "$WHOAMI_JSON" | jq -r '.drives[0].id')
            USER_ID=$(echo "$WHOAMI_JSON" | jq -r '.user.id')
            DISPLAY_NAME=$(echo "$WHOAMI_JSON" | jq -r '.user.display_name')

            sanitized=$(echo "$drive" | sed 's/:/_/')
            token_path="${DATA_DIR}/token_${sanitized}.json"

            jq --arg did "$DRIVE_ID" --arg uid "$USER_ID" --arg dn "$DISPLAY_NAME" \
              '.meta = (.meta // {}) + {
                "drive_id": $did,
                "user_id": $uid,
                "display_name": $dn,
                "org_name": "",
                "cached_at": (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }' "$token_path" > "${token_path}.tmp" \
              && mv "${token_path}.tmp" "$token_path" \
              && chmod 600 "$token_path"

            echo "  drive_id=${DRIVE_ID} user_id=${USER_ID}"
          done

      - name: Run E2E tests
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"

          # Full suite on schedule/dispatch, fast-only on push/PR.
          E2E_TAGS="e2e"
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            E2E_TAGS="e2e,e2e_full"
          fi

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            echo "=== E2E tests for: ${drive} (tags: ${E2E_TAGS}) ==="
            E2E_LOG_DIR=/tmp/e2e-debug-logs \
            ONEDRIVE_TEST_DRIVE="$drive" \
            ONEDRIVE_ALLOWED_TEST_ACCOUNTS="$ONEDRIVE_TEST_DRIVES" \
              go test -tags="${E2E_TAGS}" -race -v -timeout=30m ./e2e/...
          done

      - name: Run multi-drive E2E tests
        if: contains(env.ONEDRIVE_TEST_DRIVES, ',')
        run: |
          set -euo pipefail
          echo "=== Multi-drive E2E tests ==="
          ONEDRIVE_TEST_DRIVES_MULTI="$ONEDRIVE_TEST_DRIVES" \
          ONEDRIVE_ALLOWED_TEST_ACCOUNTS="$ONEDRIVE_TEST_DRIVES" \
            go test -tags="e2e,e2e_full" -race -v -timeout=30m \
            -run "TestE2E_MultiDrive" ./e2e/...

      - name: Upload E2E debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-debug-logs
          path: /tmp/e2e-debug-logs/
          retention-days: 7

      - name: Save rotated tokens to Key Vault
        if: always()
        run: |
          set -euo pipefail
          IFS=',' read -ra DRIVES <<< "$ONEDRIVE_TEST_DRIVES"
          DATA_DIR="$HOME/.local/share/onedrive-go"

          for drive in "${DRIVES[@]}"; do
            drive=$(echo "$drive" | xargs)
            sanitized=$(echo "$drive" | sed 's/:/_/')
            token_path="${DATA_DIR}/token_${sanitized}.json"
            secret_name="onedrive-oauth-token-$(echo "$drive" | sed 's/[:@.]/-/g')"

            if [ ! -f "$token_path" ]; then
              echo "::warning::Token file missing for drive '${drive}' — skipping save"
              continue
            fi

            if ! jq -e '.token.refresh_token' "$token_path" > /dev/null 2>&1; then
              echo "::warning::Token for drive '${drive}' has no .token.refresh_token — skipping save"
              continue
            fi

            echo "Saving rotated token for drive: ${drive}"
            az keyvault secret set \
              --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
              --name "$secret_name" \
              --file "$token_path" \
              --content-type "application/json" \
              --output none
          done

      - name: Auth failure guidance
        if: failure()
        run: |
          echo "::warning::E2E test auth may have failed."
          echo "::warning::If the refresh token has expired (90 days idle), re-bootstrap."
          echo "::warning::See docs/design/test-strategy.md for re-bootstrap instructions."
