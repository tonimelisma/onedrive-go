name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 10 * * *' # 10 AM UTC (3 AM PDT) — keeps refresh tokens alive
  workflow_dispatch:

# Cancel stale PR runs; never cancel push/schedule runs.
concurrency:
  group: ci-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  id-token: write # OIDC federation with Azure (integration + e2e jobs)

jobs:
  # --- Always-run jobs (including fork PRs) ---

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.8.0

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Test (with race detector)
        run: go test -race ./...

  # --- Live API jobs (skip on forks — no OIDC trust) ---
  # Each job uses its own dedicated test account so they run in parallel
  # without OAuth token refresh races.

  integration:
    runs-on: ubuntu-latest
    if: vars.AZURE_CLIENT_ID != ''
    env:
      ONEDRIVE_TEST_DRIVE: ${{ vars.ONEDRIVE_TEST_DRIVE_INTEGRATION }}
      ONEDRIVE_ALLOWED_TEST_ACCOUNTS: ${{ vars.ONEDRIVE_ALLOWED_TEST_ACCOUNTS }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Azure OIDC login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Download credentials to .testdata/
        run: |
          set -euo pipefail
          mkdir -p .testdata

          # Download config.
          az keyvault secret download \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "onedrive-test-config" \
            --file ".testdata/config.toml" \
            --encoding utf-8

          # Download cache file for this job's drive.
          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@._]/-/g')
          SECRET_NAME="onedrive-cache-${SANITIZED}"

          SANITIZED_FILE=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_FILE="token_${SANITIZED_FILE}.json"

          echo "Downloading: ${SECRET_NAME} → .testdata/${TOKEN_FILE}"
          az keyvault secret download \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file ".testdata/${TOKEN_FILE}" \
            --encoding utf-8

          echo "=== .testdata/ contents ==="
          ls -la .testdata/

      - name: Run integration tests
        run: |
          set -euo pipefail
          echo "=== Integration tests for: ${ONEDRIVE_TEST_DRIVE} ==="
          go test -tags=integration -race -v -timeout=5m ./internal/graph/...

      - name: Save rotated token to Key Vault
        if: always()
        run: |
          set -euo pipefail
          SANITIZED_FILE=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_PATH=".testdata/token_${SANITIZED_FILE}.json"
          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@._]/-/g')
          SECRET_NAME="onedrive-cache-${SANITIZED}"

          if [ ! -f "$TOKEN_PATH" ]; then
            echo "::warning::Token file missing — skipping save"
            exit 0
          fi

          echo "Saving rotated token"
          az keyvault secret set \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file "$TOKEN_PATH" \
            --content-type "application/json" \
            --output none

  e2e:
    runs-on: ubuntu-latest
    if: vars.AZURE_CLIENT_ID != ''
    env:
      ONEDRIVE_TEST_DRIVE: ${{ vars.ONEDRIVE_TEST_DRIVE_E2E }}
      ONEDRIVE_ALLOWED_TEST_ACCOUNTS: ${{ vars.ONEDRIVE_ALLOWED_TEST_ACCOUNTS }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build ./...

      - name: Azure OIDC login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Download credentials to .testdata/
        run: |
          set -euo pipefail
          mkdir -p .testdata

          # Download config.
          az keyvault secret download \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "onedrive-test-config" \
            --file ".testdata/config.toml" \
            --encoding utf-8

          # Download cache file for this job's drive.
          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@._]/-/g')
          SECRET_NAME="onedrive-cache-${SANITIZED}"

          SANITIZED_FILE=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_FILE="token_${SANITIZED_FILE}.json"

          echo "Downloading: ${SECRET_NAME} → .testdata/${TOKEN_FILE}"
          az keyvault secret download \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file ".testdata/${TOKEN_FILE}" \
            --encoding utf-8

          echo "=== .testdata/ contents ==="
          ls -la .testdata/

      - name: Run E2E tests
        run: |
          set -euo pipefail

          # Full suite on schedule/dispatch, fast-only on push/PR.
          E2E_TAGS="e2e"
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            E2E_TAGS="e2e,e2e_full"
          fi

          echo "=== E2E tests (tags: ${E2E_TAGS}) ==="
          E2E_LOG_DIR=/tmp/e2e-debug-logs \
            go test -tags="${E2E_TAGS}" -race -v -timeout=30m ./e2e/...

      - name: Upload E2E debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-debug-logs
          path: /tmp/e2e-debug-logs/
          retention-days: 7

      - name: Save rotated token to Key Vault
        if: always()
        run: |
          set -euo pipefail
          SANITIZED_FILE=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/:/_/')
          TOKEN_PATH=".testdata/token_${SANITIZED_FILE}.json"
          SANITIZED=$(echo "$ONEDRIVE_TEST_DRIVE" | sed 's/[:@._]/-/g')
          SECRET_NAME="onedrive-cache-${SANITIZED}"

          if [ ! -f "$TOKEN_PATH" ]; then
            echo "::warning::Token file missing — skipping save"
            exit 0
          fi

          echo "Saving rotated token"
          az keyvault secret set \
            --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" \
            --name "$SECRET_NAME" \
            --file "$TOKEN_PATH" \
            --content-type "application/json" \
            --output none

      - name: Auth failure guidance
        if: failure()
        run: |
          echo "::warning::E2E test auth may have failed."
          echo "::warning::If the refresh token has expired (90 days idle), re-bootstrap."
          echo "::warning::See docs/design/test-strategy.md for re-bootstrap instructions."
