# Backlog

Historical backlog from Phases 1-4v1 archived in `docs/archive/backlog-v1.md`.

## Active (In Progress)

| ID | Title | Priority | Package | Notes |
|----|-------|----------|---------|-------|

## Ready (Up Next)

| ID | Title | Priority | Package | Notes |
|----|-------|----------|---------|-------|

## Backlog (Architecture-Neutral)

| ID | Title | Priority | Package | Notes |
|----|-------|----------|---------|-------|
| B-026 | Replace `ONEDRIVE_TEST_DRIVE_ID` env var with typed discovery | P3 | CI + tests | CI could use a typed Go helper instead of the bootstrap tool to discover the drive ID. |
| B-030 | Review whether `internal/graph/` should be split | P2 | `internal/graph/` | Package has ~15 files. Assess cohesion vs. size. |
| B-033 | Implement accounts.md features | P1 | all | Setup wizard, `drive add`/`drive remove`, fuzzy `--drive` matching, RPC for `sync --watch`, email change detection, `service install`/`uninstall`/`status`, `status` command, `--account` flag, text-level config manipulation, commented-out config defaults on first login. |
| B-034 | Add --json support for login, logout, drive add/remove | P2 | root | These commands output plain text only. Per accounts.md §9, login should emit JSON events. |
| B-035 | Add --quiet support for login, logout, whoami, status, drive | P2 | root | Auth/drive commands write to stdout via `fmt.Printf`. File ops use `statusf()` which respects --quiet. Standardize all commands. |
| B-036 | Extract CLI service layer for testability | P2 | root | Root package at 28.1% coverage. All RunE handlers are untested. Need to extract pure logic from I/O for mock-based testing. Target: 50%+ coverage. |
| B-020 | SharePoint lock check before upload (HTTP 423) | P2 | `internal/graph/` | Check lock status before uploading to SharePoint. Avoid overwriting co-authored documents. |
| B-021 | Hash fallback chain for missing hashes | P2 | `internal/graph/` | Some Business/SharePoint files lack any hash. Fall back: QuickXorHash -> SHA256 -> size+eTag+mtime. |
| B-023 | `/children` fallback when delta incomplete | P3 | `internal/graph/` | National Cloud Deployments don't support `/delta`. Implement `/children` traversal fallback. |
| B-007 | Cross-drive DriveID handling for shared/remote items | P3 | `internal/graph/` | Verify against real API responses in E2E CI. |
| B-008 | Spec inconsistency: chunk_size units (MB vs MiB) | P2 | `docs/design/` | configuration.md says "10MB" default but requires 320 KiB multiples. Clarify spec. |
| B-031 | Profile and optimize performance | P3 | all | After feature-complete: CPU/memory/I/O profiling with `pprof`. |
| B-032 | Like-for-like performance benchmarks vs rclone and abraunegg | P3 | benchmarks | Reproducible benchmark suite comparing sync performance. |
| B-060 | Add `ResolveDrives()` for multi-drive sync | P1 | `internal/config/` | `ResolveDrive()` returns one drive. `sync` (all enabled) and `sync --drive a --drive b` need `ResolveDrives()` returning `[]*ResolvedDrive`. Required for 4v2.7 engine wiring. |
| B-061 | Shared `graph.Client` per token file for multi-drive | P2 | `internal/sync/` | Multiple drives sharing an account (business + SharePoint) should share one `graph.Client` (same token, same rate limit tracking). Engine wiring (4v2.7) should create one Client per unique token path, not per drive. |
| B-062 | Global worker pool cap for multi-drive sync | P2 | `internal/sync/` | Per-drive pools (8 dl + 8 ul + 8 hash) multiply with concurrent drives. 5 drives = 120 I/O goroutines. Need global cap or per-drive reduction when multiple drives active. Decision for 4v2.6 (executor) or 4v2.7 (engine wiring). |
| B-063 | Per-tenant rate limit coordination | P3 | `internal/graph/` | Multiple drives under same tenant share Graph API rate limits. Current per-client 429 retry works but isn't optimal. Shared rate limiter per-tenant would be better. Not critical for MVP. |
| B-064 | Baseline memory scaling for many drives | P3 | `internal/sync/` | Each drive loads full baseline into memory (~19 MB per 100K files). Additive across drives. 5 drives × 100K = ~95 MB baselines alone. Monitor during profiling (B-031). Lazy loading if needed. Also profile DepTracker memory alongside baseline (~12 MB tracker + ~20 MB actions per 100K files). |
| B-086 | Conflict notification for watch mode | P3 | `internal/sync/` | Phase 5: auto-resolved conflicts should emit events (structured log, desktop notification). |
| B-087 | Conflict retention/pruning policy | P3 | `internal/sync/` | Resolved conflicts accumulate forever. Add configurable retention (e.g., 90 days) with periodic pruning in Commit(). |
| B-071 | ConflictRecord missing Name field | P3 | `internal/sync/` | UX convenience for conflict reporting. `path.Base(Path)` suffices but Name from the PathView is cleaner. |
| B-074 | Drive identity verification at Engine startup | P2 | `internal/sync/` | Engine (4v2.7) should verify that the configured `driveid.ID` matches the API-reported drive ID at sync start. Catches stale config, renamed drives, or ID format changes. |
| B-085 | Resumable downloads (Range header) | P2 | `internal/graph/`, `internal/sync/` | Interrupted downloads restart from byte 0. Keep `.partial` file, send `Range: bytes=<size>-` on retry, append, hash-verify after completion. Matters for large files on slow connections — without this, Ctrl-C + re-sync restarts multi-GB downloads. Upload sessions already have resume via `QueryUploadSession`. |
| B-088 | Configurable auto-delete of OS junk files (.DS_Store etc.) | P3 | `internal/sync/` | Add configurable option to automatically delete OS-generated junk files during sync (e.g., `.DS_Store`, `Thumbs.db`, `desktop.ini`, `._*` resource forks). Requires research: enumerate all common OS/editor/IDE junk filenames across macOS, Windows, Linux. Consider whether to delete locally, remotely, or both. May overlap with existing always-excluded filter patterns — evaluate unifying into a single configurable exclusion/cleanup system. Reference: `.gitignore` templates, rclone `--delete-excluded`, rsync filter rules. |
| B-092 | Audit and clean up unused schema tables | P2 | `internal/sync/` | Phase 5.4 final cleanup: `stale_files`, `config_snapshots`, `change_journal` tables exist in `00001_initial_schema.sql` but are never referenced in production code. They were forward declarations from the data-model spec. Determine whether to keep (if future features need them) or drop via `00003_cleanup.sql`. Also verify `upload_sessions` table was dropped in `00002_action_queue.sql` (subsumed by ledger). |
| B-093 | Configurable DepTracker lane routing threshold | P3 | `internal/sync/` | `DepTracker.dispatch()` uses a hardcoded 10 MB size threshold to route actions to interactive vs bulk channels. Make this configurable (e.g., via `EngineConfig` or TOML `bulk_threshold`). Useful for tuning on slow connections where smaller files should still use bulk lanes, or fast SSDs where the threshold can be higher. |
| B-094 | Configurable worker pool size | P3 | `internal/sync/` | `WorkerPool.Start()` uses `runtime.NumCPU()` as total worker count. Make this configurable per-drive (e.g., TOML `max_workers`). Related to B-062 (global cap for multi-drive) — per-drive config is the building block for global coordination. |
| B-096 | Parallel hashing in LocalObserver | P2 | `internal/sync/` | `LocalObserver.FullScan()` hashes files sequentially in the `filepath.WalkDir` callback. For initial syncs of large trees with no baseline (mtime fast-path miss), this is the #1 performance bottleneck. Natural fit for Phase 5.1 watch mode work — a `CheckerPool` would sit alongside fsnotify-based observation. |
| B-097 | Ledger compaction for long-running watch mode | P3 | `internal/sync/` | Completed actions (`status='done'`) stay in `action_queue` indefinitely. In watch mode (5.2+), the table grows without bound. Add periodic `DELETE FROM action_queue WHERE status IN ('done','canceled') AND completed_at < ?` with configurable retention (default 90 days). Related: B-087 (conflict retention). |
| B-098 | Backpressure handling for LocalObserver.Watch() event channel | P2 | `internal/sync/` | If the downstream consumer (buffer) is slow, observer blocks on channel send and fsnotify's kernel buffer may overflow, silently dropping events. Options: buffered channel, internal ring buffer, or drop-and-log. Low risk given safety scan fallback, but should be evaluated under load in Phase 5.2 integration testing. |
| B-099 | Configurable safety scan interval for Watch() | P2 | `internal/sync/` | `safetyScanInterval` is hardcoded at 5 minutes. Too aggressive for large trees (full `FullScan()` walks + hashes entire tree). Should be configurable via `EngineConfig` / TOML `safety_scan_interval`. Consider default 30 min for large drives, keep 5 min option for small drives. |
| B-100 | Scan new directory contents on watch create event | P2 | `internal/sync/` | `handleCreate()` adds a watch on new directories but does not scan their contents. Files created inside the directory before the watch is registered are missed until the next safety scan. After `watcher.Add(fsPath)`, walk the new directory and emit events for any files already present. Race-tolerant: fsnotify may deliver duplicate events for files caught by both the walk and the watch — the buffer/planner deduplication handles this. |
| B-101 | Add timing and resource logging to safety scan | P3 | `internal/sync/` | `runSafetyScan()` only logs Debug entry/exit with event count. Add elapsed time, files walked, and directories scanned to the completion log line so operators can assess safety scan cost and tune the interval. |
| B-102 | `handleCreate` silently drops files when hash fails | P2 | `internal/sync/` | `handleCreate()` returns without sending any event if `computeQuickXorHash` errors. The file creation is invisible until the next safety scan (which may also fail to hash). Should send `ChangeCreate` with empty hash and let planner/executor handle it — they already handle missing hashes for Business API items. |
| B-103 | `debounceLoop` final drain can deadlock | P2 | `internal/sync/` | On ctx.Done, `debounceLoop` does `out <- batch` as a direct send. If `out` is full (buffer 1) because the consumer also exited on ctx.Done and stopped reading, this blocks forever — goroutine leak. Should be a non-blocking send or select with a discard fallback. |
| B-104 | `FlushImmediate()` logs Info on empty buffer | P3 | `internal/sync/` | In watch mode, every safety scan tick flushes the buffer. If nothing changed, `level=INFO msg="buffer flushed" paths=0` appears every scan interval. Should be Debug when empty, Info when non-empty. |
| B-105 | `addWatchesRecursive` has no aggregate failure reporting | P3 | `internal/sync/` | If many directories fail to watch (e.g., permissions), each failure logs individually at Warn. No summary. A counter + single log line ("added watches on N/M directories, K failed") at the end would make diagnostics much easier. |
| B-106 | `timeSleep` duplicated across three packages | P3 | `internal/sync/`, `internal/graph/` | Identical 10-line context-aware sleep function exists in `observer_remote.go` (`timeSleep`), `executor.go` (`timeSleepExec`), and `graph/client.go`. Could live in a tiny shared utility package to eliminate duplication, but packages can't import each other. Low priority — pure function with zero drift risk. |
| B-107 | Write event coalescing at observer level | P2 | `internal/sync/` | `handleWrite` computes a full QuickXorHash on every fsnotify Write event. Rapid saves (e.g., editor auto-save) trigger multiple redundant hash computations. A small per-path cooldown (e.g., 100ms) before hashing would eliminate wasted I/O. The buffer debounce helps downstream but the observer still does expensive work. Evaluate during Phase 5.2 load testing. |
| B-108 | No test for combined chmod+create fsnotify event | P3 | `internal/sync/` | On macOS, FSEvents sometimes delivers `Chmod\|Create` together. The filter at `handleFsEvent` correctly passes this through (ignores pure chmod only), but there's no test exercising this path. Add a test with a mock watcher sending combined event ops. |
| B-109 | `RemoteObserver.Watch()` missing interval validation | P2 | `internal/sync/` | Passing `0` or negative `interval` to `Watch()` creates a tight polling loop that hammers the Graph API with zero sleep between polls. Should enforce a minimum (e.g., 30s) or return an error on invalid input. |
| B-110 | `LocalObserver.sleepFunc` is dead code | P3 | `internal/sync/` | `sleepFunc` is set in `NewLocalObserver()` to `timeSleep` but never called — `Watch()` uses `time.NewTicker` for the safety scan interval. Violates "no speculative code" convention. Remove the field, or use it for the safety scan ticker if making the interval injectable for tests. |
| B-111 | Multiple `FlushDebounced()` calls silently break first goroutine | P2 | `internal/sync/` | Second call overwrites `b.notify` under the lock. The first goroutine's old notify channel never receives signals again — it only flushes on ctx.Done. Should either panic with "already started" or close the old notify channel to signal the first goroutine to exit. |
| B-112 | `handleDelete` doesn't remove watches for deleted directories | P3 | `internal/sync/` | On Linux, inotify auto-cleans watches on deleted inodes. On macOS/kqueue, it may not. Over time in watch mode, deleted directories accumulate stale watch descriptors — a slow resource leak. `handleDelete` doesn't receive the watcher, so it can't call `Remove()`. Needs refactoring to pass watcher + absolute path, or reconstruct the path from syncRoot + dbRelPath. |
| B-113 | `Watch()` doesn't detect sync root deletion | P2 | `internal/sync/` | If the sync root directory is deleted while watching, fsnotify sends an error to the Errors channel, which just logs Warn and continues. The watcher is now watching nothing. Should detect root deletion (e.g., periodic stat or checking for specific error) and return a fatal error. |
| B-114 | Event channel sizing undocumented in Watch() API | P3 | `internal/sync/` | `Watch()` receives `events chan<- ChangeEvent` but the API doesn't document whether it should be buffered or how large. An unbuffered channel blocks on every event. Ties into B-098 (backpressure) but is also a documentation/API-contract gap. |
| B-115 | Test: safety scan + watch producing conflicting change types for same path | P3 | `internal/sync/` | Watch sees a Create, safety scan 5 min later classifies same file as Modify (because Create was already committed to baseline). Buffer groups both under the same path — planner sees Create + Modify. Planner handles this (latest event wins), but it's an implicit contract with no dedicated test. Add an integration-style test covering this scenario. |
| B-116 | Document stale baseline interaction during watch mode | P2 | `internal/sync/` | In watch mode, `handleWrite` reads the live baseline (RWMutex-protected, sees incremental updates from executor). But `runSafetyScan` also reads the live baseline. If an action is in-flight (committed to ledger, not yet to baseline), the safety scan re-emits an event for something already being processed. Not a bug (idempotent), but the planner in Phase 5.2 needs to deduplicate against in-flight tracker actions. Document this interaction and add a test in 5.2 wiring. |
| B-117 | Test: transient file (create then immediate delete) on macOS | P3 | `internal/sync/` | macOS kqueue can coalesce rapid events. A Create followed immediately by Remove might arrive as just Remove. `handleDelete` emits a delete for something never seen as created. Baseline has no entry, so `itemType` defaults to `ItemTypeFile`. Planner should no-op on delete for non-existent path. Add a test to verify this doesn't cause errors. |
| B-118 | Test: local move produces out-of-order Rename+Create events | P3 | `internal/sync/` | A local `mv file.txt dir/file.txt` produces fsnotify Rename (delete at old path) + Create (at new path). If events arrive out of order (Create before Rename), the buffer sees Create at new path before Delete at old path. Planner handles both paths independently — verify this works correctly with a test using a mock watcher with reversed event order. |
| B-119 | Hashing actively-written files produces inconsistent state | P2 | `internal/sync/` | `handleWrite` hashes a file that may still be written to. The hash is for a partial/inconsistent state. Next Write event re-hashes, but if the file is large the hash takes seconds during which contents keep changing. The resulting hash matches nothing on either side. Upload reads yet another version. Eventually converges, but wastes bandwidth. Consider: retry hash after short delay, or compare size before/after hash to detect mid-write. |
| B-120 | Symlinked directories in sync root get no watch and no warning | P3 | `internal/sync/` | `addWatchesRecursive` uses `filepath.WalkDir` which doesn't follow symlinks. `FullScan()` also skips symlinks. Consistent behavior, but if a user symlinks a directory into their sync root expecting it to sync, nothing happens silently. Should log a Warn when a symlinked directory is encountered during watch setup. |
| B-121 | Delta token and baseline are not atomically consistent | P2 | `internal/sync/` | Crash consistency: Token means "seen all changes", baseline means "synced". RemoteObserver advances token internally after `FullDelta()`, but actions may not have executed. Crash between token advance and baseline commit leads to permanent item loss because restart starts from advanced token. Engine must control token advance. |
| B-122 | No deduplication between planner output and in-flight tracker actions | P2 | `internal/sync/` | In watch mode, the tracker is long-lived. The planner produces actions from debounce batches but doesn't know about in-flight actions (e.g., planning a Download already in progress). Requires `HasInFlight(path)` in tracker to avoid redundant work or conflicts. |
| B-123 | Repeated failure suppression missing for watch mode | P3 | `internal/sync/` | Persistent failures (size, permissions, corruption) trigger retries every safety scan and debounce cycle. Wastes CPU, bandwidth, and I/O continuously in a long-running daemon. Needs backoff or "skip after N failures" suppression logic. |
| B-124 | Watch() error semantics don't distinguish exit reasons | P2 | `internal/sync/` | `RemoteObserver.Watch()` returns nil on cancel and retries all errors internally. Engine can't distinguish "canceled" from "fatal error" from "observer stopped". Needs structured return or error channel to allow appropriate engine reaction. |
| B-125 | No health or liveness signal from Watch() goroutines | P3 | `internal/sync/` | Engine starts `Watch()` in goroutines but can't detect if they are healthy, stuck on a channel, or silently dead. Needs heartbeat callback or periodic liveness signal to detect/restart stuck observers. |
| B-126 | Buffer has no size cap | P2 | `internal/sync/` | 100K changed items produce ~19MB of `ChangeEvent` structs in the buffer's pending map. Grows without bound with no backpressure or load shedding. Under massive initial sync load, memory usage spikes with no control. |
| B-127 | No observer-level metrics or counters | P3 | `internal/sync/` | Observers lack counters for events produced, polls, hashes, or dropped fsnotify events. Essential for monitoring and diagnosing degradation in a daemon running for months. Distinct from B-101 (timing). |
| B-128 | Debounce semantics change under load | P3 | `internal/sync/` | `FlushDebounced` output channel has buffer 1. When consumer is busy, debounce blocks on send and the timer stops running. System degrades from "flush N ms after last event" to "flush as fast as consumer can process." |
| B-129 | LocalObserver.Watch() has no backoff for watcher errors | P2 | `internal/sync/` | fsnotify errors (e.g., kernel buffer overflow) trigger immediate loop and Warn log spam. Needs exponential backoff or circuit breaker to prevent tight log-spam loops under sustained error conditions. |
| B-130 | FsWatcher interface leaks fsnotify dependency through event type | P3 | `internal/sync/` | `Events()` returns `fsnotify.Event`, coupling tests/mocks to fsnotify types. Should use an abstract event type (path + operation enum) to isolate the dependency and clean up the abstraction boundary. |
| B-131 | Fix `userAgent` to use binary version constant | P2 | `internal/graph/` | `client.go` hardcodes `"onedrive-go/0.1"` — not linked to the binary's `version` constant. Server logs will always report `0.1`. Also: `NetworkConfig.UserAgent` config field is dead (never wired to client). Either wire it or remove. |
| B-132 | Fix download hash mismatch: delete `.partial` and retry or fail | P1 | `internal/sync/` | `executeDownload` warns on hash mismatch but renames `.partial` → target with wrong hash, baseline records mismatched local hash. Next scan sees hash differs from baseline's remote hash → re-downloads → infinite loop. Should delete `.partial` and retry, or mark outcome as failed. iOS `.heic` stale-hash case needs a separate code path (accept mismatch for known-stale-hash items). |
| B-133 | Track conflict copy in conflicts table on delete hash mismatch | P1 | `internal/sync/` | `deleteLocalFile` renames modified file to conflict copy on hash mismatch, then returns success outcome. Baseline entry removed, conflict copy not in conflicts table, not surfaced by `conflicts list`. Silent tracking loss. Should record a `ConflictRecord` or at minimum log at Error. |
| B-134 | Populate `remote_mtime` in conflict records | P3 | `internal/sync/` | `commitConflict` stores `remote_mtime` as `0` (line 440: `nullInt64(0)` with comment "not available in Outcome"). The mtime is available in `Action.View.Remote.Mtime` at conflict time — thread it through to `Outcome` or populate directly from the action. |
| B-135 | Promote `fsnotify` to direct dependency in `go.mod` | P2 | root | `github.com/fsnotify/fsnotify` is directly imported in `observer_local.go` but listed as `// indirect` in `go.mod`. If the transitive dependency changes, fsnotify could silently disappear. Fix: `go get github.com/fsnotify/fsnotify@v1.9.0`. |
| B-136 | Run `go mod tidy` to drop unused `golang.org/x/sync` | P2 | root | `golang.org/x/sync` was used by `executeParallel()` (deleted in Phase 5.0). Still in `go.mod` as indirect. `go mod tidy` should remove it. |
| B-137 | Validate `sync_dir` for path traversal at config load | P3 | `internal/config/` | Config-supplied paths (`sync_dir`, future `sync_paths`) used for filesystem ops without `..` or symlink-escape validation. Low risk (user-controlled config) but `filepath.Clean` + `filepath.Abs` guard at config load time would be consistent with defensive coding principles. |
| B-138 | Add upstream sync check for oauth2 fork | P3 | CI | `tonimelisma/oauth2` fork will silently fall behind upstream security patches. Add periodic `go list -m -u` check in CI, or document sync process in `CLAUDE.md` next to the replace directive. |
| B-139 | Use `http.Status*` constants in `classifyStatusCode` | P3 | `internal/sync/` | `classifyStatusCode` uses raw integers (`401`, `507`, `408`, etc.) with `//nolint:mnd`. `http.StatusUnauthorized`, `http.StatusInsufficientStorage`, etc. would eliminate nolint and be self-documenting. |
| B-140 | Set `Websocket: false` default until feature is implemented | P2 | `internal/config/` | `defaults.go` sets `Websocket: true` but websocket mode is "Future (Post-v1)". Defaulting unimplemented feature to `true` is misleading. Same for `UseRecycleBin` and `UseLocalTrash` which are `true` but not wired into executor delete logic. |
| B-141 | Add "not yet implemented" warnings for dead config fields | P2 | `internal/config/` | `SyncPaths`, `SkipFiles`, `SkipDirs`, `SkipDotfiles`, `SkipSymlinks`, `MaxFileSize`, `IgnoreMarker`, `BandwidthSchedule`, `BandwidthLimit`, `Websocket`, `UseRecycleBin`, `UseLocalTrash`, `UserAgent` are validated but silently ignored. Users believe settings take effect. Add comments and/or log warnings during validation. |
| B-142 | Remove dead `truncateToSeconds` function | P3 | `internal/sync/` | `truncateToSeconds` in `observer_local.go:784` is defined but never called in production or test code. |
| B-143 | Remove or ticket-ref `addMoveTargetDep` dead code | P3 | `internal/sync/` | `addMoveTargetDep` in `planner.go` is documented as "effectively a no-op" but retained for "defensive completeness." Either remove or add `// TODO(B-XXX)` reference. |
| B-144 | Update stale design docs post-Phase 5.0 | P2 | `docs/design/` | 6 documented divergences: `architecture.md` wrong filenames + wrong fsnotify lib + dropped `upload_sessions` table, `sync-algorithm.md` old `ActionPlan` shape + old watch mode flow, `concurrent-execution.md` specifies non-existent `CycleManager`. |
| B-145 | Add `ledger.go`/`tracker.go` API documentation | P3 | `internal/sync/` | New Phase 5.0 components with no counterpart in `docs/design/`. `concurrent-execution.md` specifies them at high level but doesn't serve as API reference. File-level package comments documenting API contracts would suffice. |
| B-146 | `shutdownCallbackServer`: inject logger instead of `slog.Default()` | P3 | `internal/graph/` | `auth.go:299` uses global logger. |
| B-147 | `bootstrapLogger`/`buildLogger`: extract shared construction logic | P3 | root | `root.go:158-213` — overlapping logic. |
| B-148 | `deduplicateItems`: replace reverse-iterate-delete with forward-pass map | P3 | `internal/graph/` | `normalize.go:80-124`. |
| B-149 | Deduplicate conflict scan logic in `baseline.go` | P3 | `internal/sync/` | `scanConflictRow`/`scanConflictRowSingle` — 80 lines duplicated. |
| B-150 | Constrain `ConflictType`/`ResolutionStrategy` with validation function | P3 | `internal/sync/` | Unconstrained string aliases. |
| B-151 | `parseTimestamp`: use `time.Unix(0,0)` sentinel instead of `time.Now()` | P3 | `internal/graph/` | Non-deterministic fallback. |
| B-152 | `checkTokenState`: use lighter token-read helper instead of full `graph.Client` | P3 | root | `status.go:158-187`. |
| B-153 | Document hash-verify skip in `resolveTransfer` conflict resolution | P3 | `internal/sync/` | `engine.go:392-420`. |
| B-154 | Sort map keys in planner for reproducible action order | P3 | `internal/sync/` | Non-deterministic map iteration aids debugging. |
| B-155 | Conflict copy timestamp: use nanosecond precision | P3 | `internal/sync/` | 1s precision → ambiguous for same-second conflicts. |
| B-156 | `rm` command: warn that folder deletion is recursive | P2 | root | `files.go:367-400` — silent recursive delete. |
| B-157 | Add `conflicts --path <path>` filter for per-path conflict history | P3 | root | Only most recent conflict surfaced per path. |
| B-158 | `DownloadURL`: implement `slog.LogValuer` for compile-time redaction | P3 | `internal/graph/` | "NEVER log" is convention-only. |
| B-159 | `doOnce`: document implicit `Content-Type: application/json` default | P3 | `internal/graph/` | Undocumented assumption. |
| B-160 | Drop or document `conflicts.history` column | P3 | `internal/sync/` | Unused column in schema. |
| B-161 | Add SQL comment for `action_queue.depends_on` encoding | P3 | `internal/sync/` | Planner indices, not ledger IDs. |
| B-162 | Add `created_at` column to `action_queue` | P3 | `internal/sync/` | Aids watch mode debugging. |
| B-163 | Add `goose Down` rollback section to migration 00001 | P3 | `internal/sync/` | Only migration without rollback. |
| B-164 | Parallelize `discoverAccount` API calls | P2 | root | Three sequential independent calls (Me, Org, Drives). |
| B-165 | Implement local trash support for sync deletes | P2 | `internal/sync/` | Move deleted local files to OS trash instead of permanent delete. macOS: `~/.Trash/`, Linux: opt-in. |
| B-166 | Add `recycle-bin list` command | P3 | root, `internal/graph/` | Show OneDrive recycle bin contents. |
| B-167 | Add `recycle-bin empty` command | P3 | root, `internal/graph/` | Permanently delete all recycle bin items. |
| B-168 | Add `recycle-bin restore` command | P3 | root, `internal/graph/` | Restore items from recycle bin. |
| B-169 | Wire `UseRecycleBin: false` for permanent remote deletion | P3 | `internal/sync/` | When disabled, sync executor calls `PermanentDeleteItem` instead of `DeleteItem`. Business/SharePoint only. |

## Event-Driven Pivot (Phase 4 v2)

| ID | Title | Priority | Package | Notes |
|----|-------|----------|---------|-------|

### Closed

| ID | Title | Resolution |
|----|-------|------------|
| B-054 | Remove old `internal/sync/` code after Phase 4v2 complete | **Superseded** — old code removal moved to Increment 0 (B-055), not end of Phase 4v2. |
| B-055 | Increment 0: Delete old sync code, stub sync command, remove tombstone config, update CI | **Done** — Phase 4v2 Increment 0 complete. Old sync engine deleted, sync.go stubbed, tombstone config removed, CI updated, clean-slate orphan branch created. |
| B-056 | Remove `tombstone_retention_days` from config package | **Done** — Completed as part of Increment 0 (B-055). |
| B-057 | Remove sync integration test line from `integration.yml` | **Done** — Completed as part of Increment 0 (B-055). |
| B-053 | Implement Phase 4v2.1: Types + Baseline Schema + BaselineManager | **Done** — PR #78. types.go, migrations, baseline.go, 25 tests, 82.5% coverage. |
| B-059 | Implement Phase 4v2.2: Remote Observer | **Done** — PR #80. observer_remote.go, 23 tests, 86.4% coverage. |
| B-065 | Implement Phase 4v2.3: Local Observer | **Done** — PR #82. observer_local.go (FullScan, name validation, always-excluded, QuickXorHash), 31 tests with real temp dirs, 87.7% coverage. |
| B-066 | Implement Phase 4v2.4: Change Buffer | **Done** — PR #84. buffer.go (thread-safe Add/AddAll/FlushImmediate, move dual-keying), 14 tests with race detector, 91.2% coverage. |
| B-067 | Implement Phase 4v2.5: Planner | **Done** — PR #85. planner.go (5-step pipeline, EF1-EF14 + ED1-ED8 decision matrices, move detection, big-delete safety), 43 tests, 91.2% coverage. |
| B-073 | DriveTokenPath/DriveStatePath should accept `driveid.CanonicalID` | **Done** — Both functions now accept `driveid.CanonicalID`. All callers migrated: `auth.go` helper chain (`discoverAccount`, `findTokenFallback`, `canonicalIDForToken`, `purgeSingleDrive`), `files.go`, `status.go`, `drive.go`, `integration_test.go`. |
| B-068 | Executor must fill zero DriveID for new local items | **Done** — PR #90. `resolveDriveID()` fills zero DriveID from executor's per-drive context. |
| B-070 | Add ParentID to Action struct | **Closed (by design)** — PR #90. Executor resolves parent IDs dynamically via `resolveParentID()` chain: createdFolders → baseline → "root". No need to add ParentID to Action. |
| B-052 | Re-enable E2E tests in CI | **Done** — 4v2.8. E2E test block uncommented in `integration.yml`. |
| B-058 | Re-enable sync E2E tests in CI after Increment 8 | **Done** — 4v2.8. Sync E2E tests written (`e2e/sync_e2e_test.go`), CI re-enabled. Interactive resolve deferred to Phase 5. |
| B-075 | Upload session leak in chunkedUpload | **Done** — Hardening. `CreateUploadSession` succeeded but `os.Open`/`uploadChunks` failure paths never canceled the session. Added `CancelUploadSession` to `TransferClient`, `cancelSession` helper, regression test. |
| B-076 | Partial file leak on f.Close() failure | **Done** — Hardening. `downloadToPartial` left `.partial` file on disk if `f.Close()` failed after successful download. Added `os.Remove(partialPath)` in Close error path. |
| B-077 | resolveTransfer nil-map panic for conflicts resolved outside Execute() | **Done** — Hardening. `executor.baseline` and `executor.createdFolders` were uninitialized when `resolveTransfer` was called from `ResolveConflict` without a prior `Execute()`. Added lazy initialization guard. |
| B-078 | TransferClient leaks upload session lifecycle to consumers | **Done** — Refactor. `TransferClient` (5 methods) replaced with `Downloader` (1) + `Uploader` (1). Upload session lifecycle (create/chunk/cancel) encapsulated in `graph.Client.Upload()`. Removed ~170 lines of duplicated state machine code from Executor and CLI. |
| B-079 | Executor conflates immutable config with per-call mutable state | **Done** — Refactor. Split `Executor` into immutable `ExecutorConfig` + ephemeral `Executor` created per `Execute()` call via `NewExecution()`. Eliminates nil-map panics and temporal coupling. Phase 5 thread-safe. |
| B-080 | Upload progress callback was nil in executeUpload | **Done** — Hardening. `executeUpload` passed `nil` for progress callback. Added per-upload Debug-level closure with path context. |
| B-081 | Simple upload doesn't preserve mtime | **Done** — Hardening. Graph API simple upload (PUT /content) can't include `fileSystemInfo`. Added `UpdateFileSystemInfo()` PATCH method, called after simple upload when mtime is non-zero. |
| B-082 | Baseline Load() queries DB on every call | **Done** — Hardening. `resolveTransfer` called `Load()` per conflict, loading full baseline N times for N conflicts. Added cache-through pattern: `Load()` returns cached `*Baseline` if available, `Commit()` invalidates and refreshes. |
| B-083 | engineMockClient lacks compile-time interface checks | **Done** — Hardening. Added `var _ Interface = (*engineMockClient)(nil)` for all 4 interfaces + design comment. |
| B-084 | EF9 edit-delete conflict fails silently (404 download loop) | **Done** — Auto-resolve: local edit wins, uploaded to re-create remote. Conflict recorded as auto-resolved in history. `conflicts --history` shows resolved conflicts. E2E tests updated. |
| B-089 | Baseline concurrent-safe incremental cache for per-action commits | **Done** — Phase 5.0. `Baseline` gains `sync.RWMutex` + locked accessors (`GetByPath`, `GetByID`, `Put`, `Delete`, `Len`, `ForEachPath`). All production code migrated. Maps remain public for test convenience. |
| B-090 | Eliminate `createdFolders` map — use incremental baseline instead | **Done** — Phase 5.0. `createdFolders` deleted. DAG edges guarantee parent folder `CommitOutcome` → `Put()` before child dispatch. `resolveParentID()` uses baseline-only lookup. |
| B-091 | `resolveTransfer()` calls batch `Commit()` — must migrate to `CommitOutcome()` | **Done** — Phase 5.0. `resolveTransfer()` calls `CommitOutcome(ctx, outcome, 0)`. `ledgerID=0` skips ledger status update for manual conflict resolution. |
| B-095 | DepTracker.byPath cleanup on action completion | **Done** — Phase 5.1. `Complete()` and `CancelByPath()` now delete `byPath` entries. Regression tests added. |
| B-037 | Add chunk upload retry for pre-auth URLs | **Done** — `doPreAuthRetry` method added to `graph.Client`. `UploadChunk` (`io.Reader` → `io.ReaderAt`), `CancelUploadSession`, `QueryUploadSession`, `downloadFromURL` all use it. Retro follow-ups: graph coverage recovered via decode-error test; baseline cache invalidation YAGNI; upload-then-PATCH purity confirmed correct. |
| B-069 | Handle locally-deleted folder with no remote delta event | **Done** — ED8 changed from ActionCleanup to ActionRemoteDelete. Both folder classifiers restructured with upfront mode filtering parallel to file path. |
| B-072 | ED1-ED8 missing folder-delete-to-remote (folder EF6) | **Done** — Fixed as part of B-069. ED8 now propagates local folder deletes to remote. |
| B-135 | Promote `fsnotify` from indirect to direct dependency | **Done** — `go mod tidy` promoted to direct. |
| B-136 | Run `go mod tidy` to drop unused `golang.org/x/sync` | **Done** — `go mod tidy` run. |
| B-139 | Use `http.Status*` constants in `classifyStatusCode` | **Done** — Replaced raw integers with `http.StatusUnauthorized`, `http.StatusInsufficientStorage`, etc. |
| B-140 | Set `Websocket: false` default until feature is implemented | **Done** — Changed to `false`. `UseLocalTrash` now platform-specific (macOS=true, Linux=false). |
| B-142 | Remove dead `truncateToSeconds` function | **Done** — Removed function and its test. |
| B-143 | Remove or ticket-ref `addMoveTargetDep` dead code | **Done** — Added `TODO(B-143)` reference to function comment. |
| B-156 | `rm` command: warn that folder deletion is recursive | **Done** — Added `--recursive` (`-r`) flag required for folder deletion, `--permanent` flag for Business/SharePoint. |
| B-165 | Implement local trash support for sync deletes | **Done** — Injectable `trashFunc` on `ExecutorConfig`, macOS `~/.Trash/` implementation, fallback to `os.Remove` on error. |
